

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>convis.filters.retina &mdash; convis 0.6.4 documentation</title>
  

  
  
  
  

  

  
  
    

  

  
  
    <link rel="stylesheet" href="../../../_static/css/theme.css" type="text/css" />
  

  

  
        <link rel="index" title="Index"
              href="../../../genindex.html"/>
        <link rel="search" title="Search" href="../../../search.html"/>
    <link rel="top" title="convis 0.6.4 documentation" href="../../../index.html"/>
        <link rel="up" title="convis.filters" href="../filters.html"/> 

  
  <script src="../../../_static/js/modernizr.min.js"></script>

</head>

<body class="wy-body-for-nav" role="document">

   
  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search">
          

          
            <a href="../../../index.html" class="icon icon-home"> convis
          

          
          </a>

          
            
            
              <div class="version">
                0.6
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">Get Started</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../installation.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../usage.html">Usage</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../examples.html">Examples</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../changelog.html">Changelog</a></li>
</ul>
<p class="caption"><span class="caption-text">Features</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../filters.html">Filters and Layers</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../pytorch_basics.html">PyTorch Basics</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../pytorch_basics.html#pytorch-extensions-in-convis">PyTorch Extensions in Convis</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../model.html">Models</a></li>
</ul>
<p class="caption"><span class="caption-text">API</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../docs.html">The API: Convis classes and modules</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../index.html">convis</a>
        
      </nav>


      
      <div class="wy-nav-content">
        <div class="rst-content">
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../../index.html">Docs</a> &raquo;</li>
        
          <li><a href="../../index.html">Module code</a> &raquo;</li>
        
          <li><a href="../../convis.html">convis</a> &raquo;</li>
        
          <li><a href="../filters.html">convis.filters</a> &raquo;</li>
        
      <li>convis.filters.retina</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <h1>Source code for convis.filters.retina</h1><div class="highlight"><pre>
<span></span><span class="kn">import</span> <span class="nn">litus</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">uuid</span>
<span class="k">try</span><span class="p">:</span>
    <span class="kn">from</span> <span class="nn">exceptions</span> <span class="k">import</span> <span class="ne">NotImplementedError</span>
<span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
    <span class="k">pass</span>

<span class="kn">from</span> <span class="nn">..base</span> <span class="k">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">..</span> <span class="k">import</span> <span class="n">base</span>
<span class="kn">from</span> <span class="nn">..filters</span> <span class="k">import</span> <span class="n">Conv1d</span><span class="p">,</span> <span class="n">Conv2d</span><span class="p">,</span> <span class="n">Conv3d</span><span class="p">,</span> <span class="n">TIME_DIMENSION</span>
<span class="kn">from</span> <span class="nn">..</span> <span class="k">import</span> <span class="n">variables</span>
<span class="kn">from</span> <span class="nn">..</span> <span class="k">import</span> <span class="n">_get_default_resolution</span>
<span class="kn">from</span> <span class="nn">..filters</span> <span class="k">import</span> <span class="n">TemporalLowPassFilterRecursive</span><span class="p">,</span> <span class="n">TemporalHighPassFilterRecursive</span><span class="p">,</span> <span class="n">SpatialRecursiveFilter</span>

<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Todo:</span>

<span class="sd"> - [ ] transient filters</span>
<span class="sd"> - [ ] filter inits for 3d kernel OPL</span>
<span class="sd"> - [ ] transient filter for Ganglion Input</span>

<span class="sd">&quot;&quot;&quot;</span>



<div class="viewcode-block" id="SeperatableOPLFilter"><a class="viewcode-back" href="../../../docs_retina.html#convis.filters.retina.SeperatableOPLFilter">[docs]</a><span class="k">class</span> <span class="nc">SeperatableOPLFilter</span><span class="p">(</span><span class="n">Layer</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        A fullly convolutional OPL implementation.</span>

<span class="sd">        All filters are implemented as convolutions which</span>
<span class="sd">        makes this layer a lot slower than :py:class:`HalfRecursiveOPLFilter`.</span>

<span class="sd">        The following virtual parameters set the corresponding</span>
<span class="sd">        tensors with convolution filters. Eg. they turn </span>
<span class="sd">        the standard deviation of the gaussian into a</span>
<span class="sd">        numerical, circular gaussian.</span>

<span class="sd">        You can set them to a value via `.set(value)` which will</span>
<span class="sd">        trigger them to re-calculate the filters.</span>

<span class="sd">        Attributes</span>
<span class="sd">        ---------------------</span>

<span class="sd">        sigma_center : virtual parameter</span>
<span class="sd">            Size of the center receptive field</span>
<span class="sd">        tau_center : virtual parameter</span>
<span class="sd">            Time constant of the center receptive field</span>
<span class="sd">        n_center : virtual parameter</span>
<span class="sd">            number of cascading exponential filters</span>
<span class="sd">        undershoot_tau_center : virtual parameter</span>
<span class="sd">            time constant of the high pass filter</span>
<span class="sd">        undershoot_relative_weight_center : virtual parameter</span>
<span class="sd">            relative weight of the high pass filter</span>
<span class="sd">        sigma_surround : virtual parameter</span>
<span class="sd">            Size of the surround receptive field</span>
<span class="sd">        tau_surround : virtual parameter</span>
<span class="sd">            Time constant of the surround receptive field</span>
<span class="sd">        relative_weight : virtual parameter</span>
<span class="sd">            relative weight between center and surround</span>
<span class="sd">        center_G</span>
<span class="sd">            Spatial convolution filter for the center receptive field</span>
<span class="sd">        center_E</span>
<span class="sd">            recursive temporal filter for the center receptive field</span>
<span class="sd">        surround_G</span>
<span class="sd">            Spatial convolution filter for the surround receptive field</span>
<span class="sd">        surround_E</span>
<span class="sd">            recursive temporal filter for the surround receptive field</span>

<span class="sd">        See Also</span>
<span class="sd">        --------</span>

<span class="sd">        convis.retina.Retina</span>
<span class="sd">        OPL</span>
<span class="sd">        HalfRecursiveOPLFilter</span>
<span class="sd">        FullConvolutionOPLFilter</span>


<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">SeperatableOPLFilter</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dims</span> <span class="o">=</span> <span class="mi">5</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">center_G</span> <span class="o">=</span> <span class="n">Conv3d</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">10</span><span class="p">,</span><span class="mi">10</span><span class="p">),</span> <span class="n">time_pad</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">autopad</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sigma_center</span> <span class="o">=</span> <span class="n">variables</span><span class="o">.</span><span class="n">VirtualParameter</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">center_G</span><span class="o">.</span><span class="n">gaussian</span><span class="p">,</span><span class="n">value</span><span class="o">=</span><span class="mf">0.05</span><span class="p">,</span><span class="n">retina_config_key</span><span class="o">=</span><span class="s1">&#39;center-sigma__deg&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">set_callback_arguments</span><span class="p">(</span><span class="n">resolution</span><span class="o">=</span><span class="n">_get_default_resolution</span><span class="p">())</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sigma_center</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="mf">0.05</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">center_E</span> <span class="o">=</span> <span class="n">Conv3d</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="p">(</span><span class="mi">5</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">),</span> <span class="n">time_pad</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">autopad</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">center_E</span><span class="o">.</span><span class="n">weight</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="o">-</span><span class="mi">5</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tau_center</span> <span class="o">=</span> <span class="n">variables</span><span class="o">.</span><span class="n">VirtualParameter</span><span class="p">(</span><span class="nb">float</span><span class="p">,</span><span class="n">value</span><span class="o">=</span><span class="mf">0.01</span><span class="p">,</span><span class="n">retina_config_key</span><span class="o">=</span><span class="s1">&#39;center-tau__sec&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">n_center</span> <span class="o">=</span> <span class="n">variables</span><span class="o">.</span><span class="n">VirtualParameter</span><span class="p">(</span><span class="nb">int</span><span class="p">,</span><span class="n">value</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="n">retina_config_key</span><span class="o">=</span><span class="s1">&#39;center-n__uint&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">f_exp_center</span> <span class="o">=</span> <span class="n">variables</span><span class="o">.</span><span class="n">VirtualParameter</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">center_E</span><span class="o">.</span><span class="n">exponential</span><span class="p">)</span><span class="o">.</span><span class="n">set_callback_arguments</span><span class="p">(</span><span class="n">tau</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">tau_center</span><span class="p">,</span><span class="n">n</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">n_center</span><span class="p">,</span><span class="n">resolution</span><span class="o">=</span><span class="n">_get_default_resolution</span><span class="p">())</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">f_exp_center</span><span class="o">.</span><span class="n">update</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">center_undershoot</span> <span class="o">=</span> <span class="n">Conv3d</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="p">(</span><span class="mi">5</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">),</span> <span class="n">time_pad</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">autopad</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">undershoot_tau_center</span> <span class="o">=</span> <span class="n">variables</span><span class="o">.</span><span class="n">VirtualParameter</span><span class="p">(</span>
            <span class="nb">float</span><span class="p">,</span>
            <span class="n">value</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span>
            <span class="n">retina_config_key</span><span class="o">=</span><span class="s1">&#39;undershoot.tau__sec&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">undershoot_relative_weight_center</span> <span class="o">=</span> <span class="n">variables</span><span class="o">.</span><span class="n">VirtualParameter</span><span class="p">(</span>
            <span class="nb">float</span><span class="p">,</span>
            <span class="n">value</span><span class="o">=</span><span class="mf">0.8</span><span class="p">,</span>
            <span class="n">retina_config_key</span><span class="o">=</span><span class="s1">&#39;undershoot.relative-weight&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">set_callback_arguments</span><span class="p">(</span><span class="n">resolution</span><span class="o">=</span><span class="n">_get_default_resolution</span><span class="p">())</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">f_undershoot</span> <span class="o">=</span> <span class="n">variables</span><span class="o">.</span><span class="n">VirtualParameter</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">center_undershoot</span><span class="o">.</span><span class="n">highpass_exponential</span><span class="p">)</span><span class="o">.</span><span class="n">set_callback_arguments</span><span class="p">(</span>
                <span class="n">tau</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">undershoot_tau_center</span><span class="p">,</span>
                <span class="n">relative_weight</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">undershoot_relative_weight_center</span><span class="p">,</span>
                <span class="n">resolution</span><span class="o">=</span><span class="n">_get_default_resolution</span><span class="p">())</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">f_undershoot</span><span class="o">.</span><span class="n">update</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">surround_G</span> <span class="o">=</span> <span class="n">Conv3d</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">19</span><span class="p">,</span><span class="mi">19</span><span class="p">),</span><span class="n">padding</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">9</span><span class="p">,</span><span class="mi">9</span><span class="p">),</span> <span class="n">autopad</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">surround_G</span><span class="o">.</span><span class="n">set_weight</span><span class="p">(</span><span class="mf">1.0</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">surround_G</span><span class="o">.</span><span class="n">gaussian</span><span class="p">(</span><span class="mf">0.15</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sigma_surround</span> <span class="o">=</span> <span class="n">variables</span><span class="o">.</span><span class="n">VirtualParameter</span><span class="p">(</span>
                                    <span class="bp">self</span><span class="o">.</span><span class="n">surround_G</span><span class="o">.</span><span class="n">gaussian</span><span class="p">,</span>
                                    <span class="n">value</span><span class="o">=</span><span class="mf">0.05</span><span class="p">,</span>
                                    <span class="n">retina_config_key</span><span class="o">=</span><span class="s1">&#39;surround-sigma__deg&#39;</span>
                                <span class="p">)</span><span class="o">.</span><span class="n">set_callback_arguments</span><span class="p">(</span>
                                    <span class="n">resolution</span><span class="o">=</span><span class="n">_get_default_resolution</span><span class="p">()</span>
                                <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sigma_surround</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="mf">0.05</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">surround_E</span> <span class="o">=</span> <span class="n">Conv3d</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="p">(</span><span class="mi">19</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">),</span><span class="n">padding</span><span class="o">=</span><span class="p">(</span><span class="mi">9</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">),</span> <span class="n">time_pad</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">autopad</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">surround_E</span><span class="p">,</span><span class="s1">&#39;bias&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">surround_E</span><span class="o">.</span><span class="n">bias</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">surround_E</span><span class="o">.</span><span class="n">bias</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tau_surround</span> <span class="o">=</span> <span class="n">variables</span><span class="o">.</span><span class="n">VirtualParameter</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">surround_E</span><span class="o">.</span><span class="n">exponential</span><span class="p">,</span><span class="n">value</span><span class="o">=</span><span class="mf">0.004</span><span class="p">,</span><span class="n">retina_config_key</span><span class="o">=</span><span class="s1">&#39;surround-tau__sec&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">set_callback_arguments</span><span class="p">(</span><span class="n">even</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">adjust_padding</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">resolution</span><span class="o">=</span><span class="n">_get_default_resolution</span><span class="p">())</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tau_surround</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="mf">0.004</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">input_state</span> <span class="o">=</span> <span class="n">State</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">)))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">relative_weight</span> <span class="o">=</span> <span class="n">Parameter</span><span class="p">(</span><span class="mf">0.5</span><span class="p">,</span><span class="n">retina_config_key</span><span class="o">=</span><span class="s1">&#39;opl-relative-weight&#39;</span><span class="p">)</span>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">filter_length</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">center_E</span><span class="o">.</span><span class="n">weight</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="n">TIME_DIMENSION</span><span class="p">]</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">center_undershoot</span><span class="o">.</span><span class="n">weight</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="n">TIME_DIMENSION</span><span class="p">]</span> <span class="o">-</span> <span class="mi">2</span><span class="p">)</span>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">filter_width</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">center_G</span><span class="o">.</span><span class="n">weight</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">filter_height</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">center_G</span><span class="o">.</span><span class="n">weight</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">filter_padding_2d</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">filter_width</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span>
                <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">filter_width</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">filter_width</span><span class="o">/</span><span class="mi">2</span><span class="p">),</span>
                <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">filter_height</span><span class="o">/</span><span class="mi">2</span><span class="p">),</span>
                <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">filter_height</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">filter_height</span><span class="o">/</span><span class="mi">2</span><span class="p">),</span>
                <span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">input_state</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="n">TIME_DIMENSION</span><span class="p">]</span> <span class="o">==</span> <span class="mi">2</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">filter_length</span> <span class="ow">and</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">input_state</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">==</span> <span class="n">x</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="ow">and</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">input_state</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">==</span> <span class="n">x</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">4</span><span class="p">]):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">input_state</span> <span class="o">=</span> <span class="n">State</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">x</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">x</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="mi">2</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">filter_length</span><span class="p">,</span><span class="n">x</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span><span class="n">x</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">4</span><span class="p">])))</span>
            <span class="n">x_init</span> <span class="o">=</span> <span class="n">x</span><span class="p">[:,:,:</span><span class="mi">2</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">filter_length</span><span class="p">,:,:]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">input_state</span><span class="p">[:,:,(</span><span class="o">-</span><span class="n">x_init</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">]):,:,:]</span> <span class="o">=</span> <span class="n">x_init</span>
            <span class="c1">#torch.zeros((1,1,self.filter_length,x.data.shape[3],x.data.shape[4]))</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_use_cuda</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">input_state</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">input_state</span><span class="o">.</span><span class="n">cuda</span><span class="p">()</span>
            <span class="n">x_pad</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">input_state</span><span class="o">.</span><span class="n">cuda</span><span class="p">(),</span> <span class="n">x</span><span class="o">.</span><span class="n">cuda</span><span class="p">()],</span> <span class="n">dim</span><span class="o">=</span><span class="n">TIME_DIMENSION</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">input_state</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">input_state</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span>
            <span class="c1">#print self.input_state, x</span>
            <span class="n">x_pad</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">input_state</span><span class="o">.</span><span class="n">cpu</span><span class="p">(),</span> <span class="n">x</span><span class="o">.</span><span class="n">cpu</span><span class="p">()],</span> <span class="n">dim</span><span class="o">=</span><span class="n">TIME_DIMENSION</span><span class="p">)</span>
        <span class="n">y</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">center_G</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">functional</span><span class="o">.</span><span class="n">pad</span><span class="p">(</span><span class="n">x_pad</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">filter_padding_2d</span><span class="p">,</span><span class="s1">&#39;replicate&#39;</span><span class="p">))</span>
        <span class="n">y</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">center_E</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>
        <span class="n">y</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">center_undershoot</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>
        <span class="n">s</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">surround_G</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>
        <span class="n">s</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">surround_E</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">functional</span><span class="o">.</span><span class="n">pad</span><span class="p">(</span><span class="n">y</span><span class="p">,((</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">surround_E</span><span class="p">),</span><span class="mi">0</span><span class="p">)),</span><span class="s1">&#39;replicate&#39;</span><span class="p">))</span>

        <span class="n">y</span> <span class="o">=</span> <span class="n">y</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">relative_weight</span> <span class="o">*</span> <span class="n">s</span><span class="p">[:,:,</span><span class="o">-</span><span class="n">y</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="n">TIME_DIMENSION</span><span class="p">]:,:,:]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">input_state</span> <span class="o">=</span> <span class="n">x_pad</span><span class="p">[:,:,</span><span class="o">-</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">filter_length</span><span class="p">):,:,:]</span>
        <span class="c1">#return y[:,:,(self.filter_length/2):-(self.filter_length/2),:,:]</span>
        <span class="k">return</span> <span class="n">y</span><span class="p">[:,:,</span><span class="bp">self</span><span class="o">.</span><span class="n">filter_length</span><span class="p">:,:,:]</span></div>

<div class="viewcode-block" id="HalfRecursiveOPLFilter"><a class="viewcode-back" href="../../../docs_retina.html#convis.filters.retina.HalfRecursiveOPLFilter">[docs]</a><span class="k">class</span> <span class="nc">HalfRecursiveOPLFilter</span><span class="p">(</span><span class="n">Layer</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        The default OPL implementation.</span>

<span class="sd">        Temporal filters are implemented recursively and</span>
<span class="sd">        spatial filters are convolution filters.</span>

<span class="sd">        The following virtual parameters set the corresponding</span>
<span class="sd">        tensors with convolution filters. Eg. they turn </span>
<span class="sd">        the standard deviation of the gaussian into a</span>
<span class="sd">        numerical, circular gaussian.</span>

<span class="sd">        You can set them to a value via `.set(value)` which will</span>
<span class="sd">        trigger them to re-calculate the filters.</span>

<span class="sd">        Attributes</span>
<span class="sd">        --------------------</span>

<span class="sd">        sigma_center : virtual parameter</span>
<span class="sd">            Size of the center receptive field</span>
<span class="sd">        tau_center : virtual parameter</span>
<span class="sd">            Time constant of the center receptive field</span>
<span class="sd">        n_center : virtual parameter</span>
<span class="sd">            number of cascading exponential filters</span>
<span class="sd">        undershoot_tau_center : virtual parameter</span>
<span class="sd">            time constant of the high pass filter</span>
<span class="sd">        undershoot_relative_weight_center : virtual parameter</span>
<span class="sd">            relative weight of the high pass filter</span>
<span class="sd">        sigma_surround : virtual parameter</span>
<span class="sd">            Size of the surround receptive field</span>
<span class="sd">        tau_surround : virtual parameter</span>
<span class="sd">            Time constant of the surround receptive field</span>
<span class="sd">        relative_weight : virtual parameter</span>
<span class="sd">            relative weight between center and surround</span>
<span class="sd">        center_G : Conv3d</span>
<span class="sd">            Spatial convolution filter for the center receptive field</span>
<span class="sd">        center_E : Recursive Filter</span>
<span class="sd">            recursive temporal filter for the center receptive field</span>
<span class="sd">        surround_G : Conv3d</span>
<span class="sd">            Spatial convolution filter for the surround receptive field</span>
<span class="sd">        surround_E : Recursive Filter</span>
<span class="sd">            recursive temporal filter for the surround receptive field</span>


<span class="sd">        See Also</span>
<span class="sd">        --------</span>

<span class="sd">        convis.retina.Retina</span>
<span class="sd">        OPL</span>
<span class="sd">        SeperatableOPLFilter</span>
<span class="sd">        FullConvolutionOPLFilter</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">HalfRecursiveOPLFilter</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dims</span> <span class="o">=</span> <span class="mi">5</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">center_G</span> <span class="o">=</span> <span class="n">Conv3d</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">10</span><span class="p">,</span><span class="mi">10</span><span class="p">),</span> <span class="n">time_pad</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">autopad</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">center_G</span><span class="o">.</span><span class="n">set_weight</span><span class="p">(</span><span class="mf">1.0</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">center_G</span><span class="o">.</span><span class="n">gaussian</span><span class="p">(</span><span class="mf">0.05</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sigma_center</span> <span class="o">=</span> <span class="n">variables</span><span class="o">.</span><span class="n">VirtualParameter</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">center_G</span><span class="o">.</span><span class="n">gaussian</span><span class="p">,</span><span class="n">value</span><span class="o">=</span><span class="mf">0.05</span><span class="p">,</span><span class="n">retina_config_key</span><span class="o">=</span><span class="s1">&#39;center-sigma__deg&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">set_callback_arguments</span><span class="p">(</span><span class="n">resolution</span><span class="o">=</span><span class="n">_get_default_resolution</span><span class="p">())</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">center_E</span> <span class="o">=</span> <span class="n">TemporalLowPassFilterRecursive</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tau_center</span> <span class="o">=</span> <span class="n">variables</span><span class="o">.</span><span class="n">VirtualParameter</span><span class="p">(</span><span class="nb">float</span><span class="p">,</span><span class="n">value</span><span class="o">=</span><span class="mf">0.01</span><span class="p">,</span><span class="n">retina_config_key</span><span class="o">=</span><span class="s1">&#39;center-tau__sec&#39;</span><span class="p">,</span><span class="n">var</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">center_E</span><span class="o">.</span><span class="n">tau</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">n_center</span> <span class="o">=</span> <span class="n">variables</span><span class="o">.</span><span class="n">VirtualParameter</span><span class="p">(</span><span class="nb">int</span><span class="p">,</span><span class="n">value</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="n">retina_config_key</span><span class="o">=</span><span class="s1">&#39;center-n__uint&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">center_undershoot</span> <span class="o">=</span> <span class="n">TemporalHighPassFilterRecursive</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">undershoot_tau_center</span> <span class="o">=</span> <span class="n">variables</span><span class="o">.</span><span class="n">VirtualParameter</span><span class="p">(</span>
            <span class="nb">float</span><span class="p">,</span>
            <span class="n">value</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span>
            <span class="n">retina_config_key</span><span class="o">=</span><span class="s1">&#39;undershoot.tau__sec&#39;</span><span class="p">,</span>
            <span class="n">var</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">center_undershoot</span><span class="o">.</span><span class="n">tau</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">undershoot_relative_weight_center</span> <span class="o">=</span> <span class="n">variables</span><span class="o">.</span><span class="n">VirtualParameter</span><span class="p">(</span>
            <span class="nb">float</span><span class="p">,</span>
            <span class="n">value</span><span class="o">=</span><span class="mf">0.8</span><span class="p">,</span>
            <span class="n">retina_config_key</span><span class="o">=</span><span class="s1">&#39;undershoot.relative-weight&#39;</span><span class="p">,</span>
            <span class="n">var</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">center_undershoot</span><span class="o">.</span><span class="n">k</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">surround_G</span> <span class="o">=</span> <span class="n">Conv3d</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">19</span><span class="p">,</span><span class="mi">19</span><span class="p">),</span> <span class="n">adjust_padding</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">time_pad</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">autopad</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">surround_G</span><span class="o">.</span><span class="n">set_weight</span><span class="p">(</span><span class="mf">1.0</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">surround_G</span><span class="o">.</span><span class="n">gaussian</span><span class="p">(</span><span class="mf">0.15</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sigma_surround</span> <span class="o">=</span> <span class="n">variables</span><span class="o">.</span><span class="n">VirtualParameter</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">surround_G</span><span class="o">.</span><span class="n">gaussian</span><span class="p">,</span><span class="n">value</span><span class="o">=</span><span class="mf">0.05</span><span class="p">,</span><span class="n">retina_config_key</span><span class="o">=</span><span class="s1">&#39;surround-sigma__deg&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">set_callback_arguments</span><span class="p">(</span><span class="n">resolution</span><span class="o">=</span><span class="n">_get_default_resolution</span><span class="p">())</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sigma_surround</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="mf">0.05</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">surround_E</span> <span class="o">=</span> <span class="n">TemporalLowPassFilterRecursive</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tau_surround</span> <span class="o">=</span> <span class="n">variables</span><span class="o">.</span><span class="n">VirtualParameter</span><span class="p">(</span><span class="nb">float</span><span class="p">,</span><span class="n">value</span><span class="o">=</span><span class="mf">0.004</span><span class="p">,</span><span class="n">retina_config_key</span><span class="o">=</span><span class="s1">&#39;surround-tau__sec&#39;</span><span class="p">,</span><span class="n">var</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">surround_E</span><span class="o">.</span><span class="n">tau</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">input_state</span> <span class="o">=</span> <span class="n">State</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">)))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">relative_weight</span> <span class="o">=</span> <span class="n">Parameter</span><span class="p">(</span><span class="mf">0.5</span><span class="p">,</span><span class="n">retina_config_key</span><span class="o">=</span><span class="s1">&#39;opl-relative-weight&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lambda_opl</span> <span class="o">=</span> <span class="n">Parameter</span><span class="p">(</span><span class="mf">1.0</span><span class="p">,</span><span class="n">retina_config_key</span><span class="o">=</span><span class="s1">&#39;opl-amplification&#39;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">clear</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">center_E</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">center_undershoot</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">surround_E</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">filter_width</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">center_G</span><span class="o">.</span><span class="n">weight</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">filter_height</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">center_G</span><span class="o">.</span><span class="n">weight</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">filter_padding_2d</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">filter_width</span><span class="o">/</span><span class="mi">2</span><span class="p">),</span>
                <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">filter_width</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">filter_width</span><span class="o">/</span><span class="mi">2</span><span class="p">),</span>
                <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">filter_height</span><span class="o">/</span><span class="mi">2</span><span class="p">),</span>
                <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">filter_height</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">filter_height</span><span class="o">/</span><span class="mi">2</span><span class="p">),</span>
                <span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_use_cuda</span><span class="p">:</span>
            <span class="n">x</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">cuda</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">x</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span>
        <span class="n">y</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">center_G</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">functional</span><span class="o">.</span><span class="n">pad</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">filter_padding_2d</span><span class="p">,</span><span class="s1">&#39;replicate&#39;</span><span class="p">))</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">lambda_opl</span>
        <span class="n">y</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">center_E</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>
        <span class="n">y</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">center_undershoot</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>
        <span class="n">s</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">surround_G</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">functional</span><span class="o">.</span><span class="n">pad</span><span class="p">(</span><span class="n">y</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">surround_G</span><span class="o">.</span><span class="n">kernel_padding</span><span class="p">,</span><span class="s1">&#39;replicate&#39;</span><span class="p">))</span>
        <span class="n">s</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">surround_E</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">center_signal</span> <span class="o">=</span> <span class="n">y</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">surround_signal</span> <span class="o">=</span> <span class="n">s</span>
        <span class="n">y</span> <span class="o">=</span> <span class="n">y</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">relative_weight</span> <span class="o">*</span> <span class="n">s</span><span class="p">[:,:,:,:,:]</span>
        <span class="k">return</span> <span class="n">y</span></div>

<div class="viewcode-block" id="RecursiveOPLFilter"><a class="viewcode-back" href="../../../docs_retina.html#convis.filters.retina.RecursiveOPLFilter">[docs]</a><span class="k">class</span> <span class="nc">RecursiveOPLFilter</span><span class="p">(</span><span class="n">Layer</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        The most efficient OPL implementation.</span>

<span class="sd">        Temporal and spatial filters are implemented recursively.</span>

<span class="sd">        The following virtual parameters set the corresponding</span>
<span class="sd">        tensors with convolution filters. Eg. they turn </span>
<span class="sd">        the standard deviation of the gaussian into a</span>
<span class="sd">        numerical, circular gaussian.</span>

<span class="sd">        You can set them to a value via `.set(value)` which will</span>
<span class="sd">        trigger them to re-calculate the filters.</span>

<span class="sd">        Attributes</span>
<span class="sd">        --------------------</span>

<span class="sd">        sigma_center : virtual parameter</span>
<span class="sd">            Size of the center receptive field</span>
<span class="sd">        tau_center : virtual parameter</span>
<span class="sd">            Time constant of the center receptive field</span>
<span class="sd">        n_center : virtual parameter</span>
<span class="sd">            number of cascading exponential filters</span>
<span class="sd">        undershoot_tau_center : virtual parameter</span>
<span class="sd">            time constant of the high pass filter</span>
<span class="sd">        undershoot_relative_weight_center : virtual parameter</span>
<span class="sd">            relative weight of the high pass filter</span>
<span class="sd">        sigma_surround : virtual parameter</span>
<span class="sd">            Size of the surround receptive field</span>
<span class="sd">        tau_surround : virtual parameter</span>
<span class="sd">            Time constant of the surround receptive field</span>
<span class="sd">        relative_weight : virtual parameter</span>
<span class="sd">            relative weight between center and surround</span>
<span class="sd">        center_G : Conv3d</span>
<span class="sd">            Spatial convolution filter for the center receptive field</span>
<span class="sd">        center_E : Recursive Filter</span>
<span class="sd">            recursive temporal filter for the center receptive field</span>
<span class="sd">        surround_G : Conv3d</span>
<span class="sd">            Spatial convolution filter for the surround receptive field</span>
<span class="sd">        surround_E : Recursive Filter</span>
<span class="sd">            recursive temporal filter for the surround receptive field</span>


<span class="sd">        See Also</span>
<span class="sd">        --------</span>

<span class="sd">        convis.retina.Retina</span>
<span class="sd">        OPL</span>
<span class="sd">        SeperatableOPLFilter</span>
<span class="sd">        FullConvolutionOPLFilter</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">RecursiveOPLFilter</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dims</span> <span class="o">=</span> <span class="mi">5</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">center_G</span> <span class="o">=</span> <span class="n">SpatialRecursiveFilter</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">center_G</span><span class="o">.</span><span class="n">gaussian</span><span class="p">(</span><span class="mf">0.05</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sigma_center</span> <span class="o">=</span> <span class="n">variables</span><span class="o">.</span><span class="n">VirtualParameter</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">center_G</span><span class="o">.</span><span class="n">gaussian</span><span class="p">,</span><span class="n">value</span><span class="o">=</span><span class="mf">0.05</span><span class="p">,</span>
            <span class="n">retina_config_key</span><span class="o">=</span><span class="s1">&#39;center-sigma__deg&#39;</span><span class="p">,</span>
            <span class="n">doc</span><span class="o">=</span><span class="s1">&#39;Size of the center receptive field (calls self.center_G.gaussian)&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">set_callback_arguments</span><span class="p">(</span><span class="n">resolution</span><span class="o">=</span><span class="n">_get_default_resolution</span><span class="p">())</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">center_E</span> <span class="o">=</span> <span class="n">TemporalLowPassFilterRecursive</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tau_center</span> <span class="o">=</span> <span class="n">variables</span><span class="o">.</span><span class="n">VirtualParameter</span><span class="p">(</span><span class="nb">float</span><span class="p">,</span><span class="n">value</span><span class="o">=</span><span class="mf">0.01</span><span class="p">,</span>
            <span class="n">retina_config_key</span><span class="o">=</span><span class="s1">&#39;center-tau__sec&#39;</span><span class="p">,</span><span class="n">var</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">center_E</span><span class="o">.</span><span class="n">tau</span><span class="p">,</span>
            <span class="n">doc</span><span class="o">=</span><span class="s1">&#39;Time constant of the center receptive field (sets self.center_E.tau)&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">n_center</span> <span class="o">=</span> <span class="n">variables</span><span class="o">.</span><span class="n">VirtualParameter</span><span class="p">(</span><span class="nb">int</span><span class="p">,</span><span class="n">value</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
            <span class="n">retina_config_key</span><span class="o">=</span><span class="s1">&#39;center-n__uint&#39;</span><span class="p">,</span>
            <span class="n">doc</span><span class="o">=</span><span class="s1">&#39;Number of successive exponential filters in the filter cascade (n=0: a single exponential filter).&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">center_undershoot</span> <span class="o">=</span> <span class="n">TemporalHighPassFilterRecursive</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">undershoot_tau_center</span> <span class="o">=</span> <span class="n">variables</span><span class="o">.</span><span class="n">VirtualParameter</span><span class="p">(</span>
            <span class="nb">float</span><span class="p">,</span>
            <span class="n">value</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span>
            <span class="n">retina_config_key</span><span class="o">=</span><span class="s1">&#39;undershoot.tau__sec&#39;</span><span class="p">,</span>
            <span class="n">var</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">center_undershoot</span><span class="o">.</span><span class="n">tau</span><span class="p">,</span>
            <span class="n">doc</span><span class="o">=</span><span class="s1">&#39;time constant of the high pass filter (sets self.center_undershoot.tau)&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">undershoot_relative_weight_center</span> <span class="o">=</span> <span class="n">variables</span><span class="o">.</span><span class="n">VirtualParameter</span><span class="p">(</span>
            <span class="nb">float</span><span class="p">,</span>
            <span class="n">value</span><span class="o">=</span><span class="mf">0.8</span><span class="p">,</span>
            <span class="n">retina_config_key</span><span class="o">=</span><span class="s1">&#39;undershoot.relative-weight&#39;</span><span class="p">,</span>
            <span class="n">var</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">center_undershoot</span><span class="o">.</span><span class="n">k</span><span class="p">,</span>
            <span class="n">doc</span><span class="o">=</span><span class="s1">&#39;relative weight of the high pass filter (sets self.center_undershoot.k)&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">surround_G</span> <span class="o">=</span> <span class="n">SpatialRecursiveFilter</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">surround_G</span><span class="o">.</span><span class="n">gaussian</span><span class="p">(</span><span class="mf">0.15</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sigma_surround</span> <span class="o">=</span> <span class="n">variables</span><span class="o">.</span><span class="n">VirtualParameter</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">surround_G</span><span class="o">.</span><span class="n">gaussian</span><span class="p">,</span><span class="n">value</span><span class="o">=</span><span class="mf">0.15</span><span class="p">,</span>
            <span class="n">retina_config_key</span><span class="o">=</span><span class="s1">&#39;surround-sigma__deg&#39;</span><span class="p">,</span>
            <span class="n">doc</span><span class="o">=</span><span class="s1">&#39;Size of the surround receptive field (calls self.surround_G.gaussian)&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">set_callback_arguments</span><span class="p">(</span><span class="n">resolution</span><span class="o">=</span><span class="n">_get_default_resolution</span><span class="p">())</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sigma_surround</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="mf">0.15</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">surround_E</span> <span class="o">=</span> <span class="n">TemporalLowPassFilterRecursive</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tau_surround</span> <span class="o">=</span> <span class="n">variables</span><span class="o">.</span><span class="n">VirtualParameter</span><span class="p">(</span><span class="nb">float</span><span class="p">,</span><span class="n">value</span><span class="o">=</span><span class="mf">0.004</span><span class="p">,</span>
            <span class="n">retina_config_key</span><span class="o">=</span><span class="s1">&#39;surround-tau__sec&#39;</span><span class="p">,</span><span class="n">var</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">surround_E</span><span class="o">.</span><span class="n">tau</span><span class="p">,</span>
            <span class="n">doc</span><span class="o">=</span><span class="s1">&#39;Time constant of the surround receptive field (sets self.surround_E.tau)&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">input_state</span> <span class="o">=</span> <span class="n">State</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">)))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">relative_weight</span> <span class="o">=</span> <span class="n">Parameter</span><span class="p">(</span><span class="mf">0.5</span><span class="p">,</span><span class="n">retina_config_key</span><span class="o">=</span><span class="s1">&#39;opl-relative-weight&#39;</span><span class="p">,</span>
            <span class="n">doc</span><span class="o">=</span><span class="s1">&#39;relative weight between center and surround&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lambda_opl</span> <span class="o">=</span> <span class="n">Parameter</span><span class="p">(</span><span class="mf">1.0</span><span class="p">,</span><span class="n">retina_config_key</span><span class="o">=</span><span class="s1">&#39;opl-amplification&#39;</span><span class="p">,</span>
            <span class="n">doc</span><span class="o">=</span><span class="s1">&#39;Linear amplification of the output&#39;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">clear</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">center_E</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">center_undershoot</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">surround_E</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
    <span class="k">def</span> <span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_use_cuda</span><span class="p">:</span>
            <span class="n">x</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">cuda</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">x</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span>
        <span class="n">y</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">center_G</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">lambda_opl</span>
        <span class="n">y</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">center_E</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>
        <span class="n">y</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">center_undershoot</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>
        <span class="n">s</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">surround_G</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>
        <span class="n">s</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">surround_E</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">center_signal</span> <span class="o">=</span> <span class="n">y</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">surround_signal</span> <span class="o">=</span> <span class="n">s</span>
        <span class="n">y</span> <span class="o">=</span> <span class="n">y</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">relative_weight</span> <span class="o">*</span> <span class="n">s</span><span class="p">[:,:,:,:,:]</span>
        <span class="k">return</span> <span class="n">y</span></div>

<div class="viewcode-block" id="FullConvolutionOPLFilter"><a class="viewcode-back" href="../../../docs_retina.html#convis.filters.retina.FullConvolutionOPLFilter">[docs]</a><span class="k">class</span> <span class="nc">FullConvolutionOPLFilter</span><span class="p">(</span><span class="n">Layer</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Convolution OPL Filter</span>

<span class="sd">        The VirtualParameters of the model create a 3d convolution filter.</span>
<span class="sd">        Any time they are changed, the current filter will be replaced!</span>
<span class="sd">        The VirtualParameters can not be optimized, only the </span>
<span class="sd">        convolution filter will change when using an optimizer.</span>
<span class="sd">        </span>

<span class="sd">        See Also</span>
<span class="sd">        --------</span>

<span class="sd">        convis.retina.Retina</span>
<span class="sd">        OPL</span>
<span class="sd">        HalfRecursiveOPLFilter</span>
<span class="sd">        SeperatableOPLFilter</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">shp</span><span class="o">=</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span><span class="mi">10</span><span class="p">,</span><span class="mi">10</span><span class="p">)):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">FullConvolutionOPLFilter</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dims</span> <span class="o">=</span> <span class="mi">5</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">conv</span> <span class="o">=</span> <span class="n">Conv3d</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">shp</span><span class="p">,</span> <span class="n">time_pad</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">autopad</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">conv</span><span class="o">.</span><span class="n">bias</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">conv</span><span class="o">.</span><span class="n">weight</span><span class="o">.</span><span class="n">data</span><span class="p">[:,:,:,:,:]</span> <span class="o">=</span> <span class="mf">0.0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sigma_center</span> <span class="o">=</span> <span class="n">variables</span><span class="o">.</span><span class="n">VirtualParameter</span><span class="p">(</span><span class="nb">float</span><span class="p">,</span><span class="n">value</span><span class="o">=</span><span class="mf">0.05</span><span class="p">,</span><span class="n">retina_config_key</span><span class="o">=</span><span class="s1">&#39;center-sigma__deg&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tau_center</span> <span class="o">=</span> <span class="n">variables</span><span class="o">.</span><span class="n">VirtualParameter</span><span class="p">(</span><span class="nb">float</span><span class="p">,</span><span class="n">value</span><span class="o">=</span><span class="mf">0.01</span><span class="p">,</span><span class="n">retina_config_key</span><span class="o">=</span><span class="s1">&#39;center-tau__sec&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">n_center</span> <span class="o">=</span> <span class="n">variables</span><span class="o">.</span><span class="n">VirtualParameter</span><span class="p">(</span><span class="nb">int</span><span class="p">,</span><span class="n">value</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="n">retina_config_key</span><span class="o">=</span><span class="s1">&#39;center-n__uint&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">undershoot_tau_center</span> <span class="o">=</span> <span class="n">variables</span><span class="o">.</span><span class="n">VirtualParameter</span><span class="p">(</span>
            <span class="nb">float</span><span class="p">,</span>
            <span class="n">value</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span>
            <span class="n">retina_config_key</span><span class="o">=</span><span class="s1">&#39;undershoot.tau__sec&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">undershoot_relative_weight_center</span> <span class="o">=</span> <span class="n">variables</span><span class="o">.</span><span class="n">VirtualParameter</span><span class="p">(</span>
            <span class="nb">float</span><span class="p">,</span>
            <span class="n">value</span><span class="o">=</span><span class="mf">0.8</span><span class="p">,</span>
            <span class="n">retina_config_key</span><span class="o">=</span><span class="s1">&#39;undershoot.relative-weight&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sigma_surround</span> <span class="o">=</span> <span class="n">variables</span><span class="o">.</span><span class="n">VirtualParameter</span><span class="p">(</span><span class="nb">float</span><span class="p">,</span><span class="n">value</span><span class="o">=</span><span class="mf">0.15</span><span class="p">,</span><span class="n">retina_config_key</span><span class="o">=</span><span class="s1">&#39;surround-sigma__deg&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tau_surround</span> <span class="o">=</span> <span class="n">variables</span><span class="o">.</span><span class="n">VirtualParameter</span><span class="p">(</span><span class="nb">float</span><span class="p">,</span><span class="n">value</span><span class="o">=</span><span class="mf">0.004</span><span class="p">,</span><span class="n">retina_config_key</span><span class="o">=</span><span class="s1">&#39;surround-tau__sec&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">relative_weight</span> <span class="o">=</span> <span class="n">Parameter</span><span class="p">(</span><span class="mf">0.5</span><span class="p">,</span><span class="n">retina_config_key</span><span class="o">=</span><span class="s1">&#39;opl-relative-weight&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lambda_opl</span> <span class="o">=</span> <span class="n">Parameter</span><span class="p">(</span><span class="mf">1.0</span><span class="p">,</span><span class="n">retina_config_key</span><span class="o">=</span><span class="s1">&#39;opl-amplification&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_callback</span> <span class="o">=</span> <span class="n">variables</span><span class="o">.</span><span class="n">VirtualParameter</span><span class="p">(</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">create_kernel</span>
                        <span class="p">)</span><span class="o">.</span><span class="n">set_callback_arguments</span><span class="p">(</span>
                            <span class="n">sigma_center</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sigma_center</span><span class="p">,</span>
                            <span class="n">tau_center</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tau_center</span><span class="p">,</span>
                            <span class="n">n_center</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_center</span><span class="p">,</span>
                            <span class="n">undershoot_tau_center</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">undershoot_tau_center</span><span class="p">,</span>
                            <span class="n">undershoot_relative_weight_center</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">undershoot_relative_weight_center</span><span class="p">,</span>
                            <span class="n">sigma_surround</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sigma_surround</span><span class="p">,</span>
                            <span class="n">tau_surround</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tau_surround</span><span class="p">,</span>
                            <span class="n">relative_weight</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">relative_weight</span><span class="p">,</span>
                            <span class="n">lambda_opl</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lambda_opl</span>
                        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_callback</span><span class="o">.</span><span class="n">update</span><span class="p">()</span>
    <span class="k">def</span> <span class="nf">create_kernel</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sigma_center</span><span class="p">,</span>
                            <span class="n">tau_center</span><span class="p">,</span>
                            <span class="n">n_center</span><span class="p">,</span>
                            <span class="n">undershoot_tau_center</span><span class="p">,</span>
                            <span class="n">undershoot_relative_weight_center</span><span class="p">,</span>
                            <span class="n">sigma_surround</span><span class="p">,</span>
                            <span class="n">tau_surround</span><span class="p">,</span>
                            <span class="n">relative_weight</span><span class="p">,</span>
                            <span class="n">lambda_opl</span><span class="p">):</span>
        <span class="n">tmp_opl</span> <span class="o">=</span> <span class="n">RecursiveOPLFilter</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tmp_opl</span> <span class="o">=</span> <span class="n">tmp_opl</span>
        <span class="n">tmp_opl</span><span class="o">.</span><span class="n">sigma_center</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">sigma_center</span><span class="p">)</span>
        <span class="n">tmp_opl</span><span class="o">.</span><span class="n">tau_center</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">tau_center</span><span class="p">)</span>
        <span class="n">tmp_opl</span><span class="o">.</span><span class="n">n_center</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">n_center</span><span class="p">)</span>
        <span class="n">tmp_opl</span><span class="o">.</span><span class="n">undershoot_tau_center</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">undershoot_tau_center</span><span class="p">)</span>
        <span class="n">tmp_opl</span><span class="o">.</span><span class="n">undershoot_relative_weight_center</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">undershoot_relative_weight_center</span><span class="p">)</span>
        <span class="n">tmp_opl</span><span class="o">.</span><span class="n">sigma_surround</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">sigma_surround</span><span class="p">)</span>
        <span class="n">tmp_opl</span><span class="o">.</span><span class="n">tau_surround</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">tau_surround</span><span class="p">)</span>
        <span class="n">tmp_opl</span><span class="o">.</span><span class="n">relative_weight</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">relative_weight</span><span class="p">)</span>
        <span class="n">tmp_opl</span><span class="o">.</span><span class="n">lambda_opl</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">lambda_opl</span><span class="p">)</span>
        <span class="n">shp</span><span class="o">=</span><span class="nb">tuple</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">conv</span><span class="o">.</span><span class="n">weight</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
        <span class="c1">#tmp_opl.clear_state()</span>
        <span class="n">inp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">shp</span><span class="p">)</span>
        <span class="n">inp</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="nb">int</span><span class="p">(</span><span class="n">shp</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">/</span><span class="mi">2</span><span class="p">),</span><span class="nb">int</span><span class="p">(</span><span class="n">shp</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span><span class="o">/</span><span class="mi">2</span><span class="p">)]</span> <span class="o">=</span> <span class="mf">1.0</span>
        <span class="n">w</span> <span class="o">=</span> <span class="n">tmp_opl</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">inp</span><span class="p">,</span><span class="n">dt</span><span class="o">=</span><span class="mi">100</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">conv</span><span class="o">.</span><span class="n">set_weight</span><span class="p">(</span><span class="n">base</span><span class="o">.</span><span class="n">_array</span><span class="p">(</span><span class="n">w</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">])[::</span><span class="o">-</span><span class="mi">1</span><span class="p">,::</span><span class="o">-</span><span class="mi">1</span><span class="p">,::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">())</span>
        <span class="k">return</span> <span class="n">w</span>
    <span class="k">def</span> <span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">conv</span><span class="p">(</span><span class="n">x</span><span class="p">)</span></div>

    
<div class="viewcode-block" id="OPL"><a class="viewcode-back" href="../../../docs_retina.html#convis.filters.retina.OPL">[docs]</a><span class="k">class</span> <span class="nc">OPL</span><span class="p">(</span><span class="n">Layer</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    The OPL current is a filtered version of the luminance input with spatial and temporal kernels.</span>

<span class="sd">    $$I_{OLP}(x,y,t) = \lambda_{OPL}(C(x,y,t) - w_{OPL} S(x,y,t)_)$$</span>

<span class="sd">    with:</span>

<span class="sd">    :math:`C(x,y,t) = G * T(wu,Tu) * E(n,t) * L (x,y,t)`</span>

<span class="sd">    :math:`S(x,y,t) = G * E * C(x,y,t)`</span>

<span class="sd">    In the case of leaky heat equation:</span>

<span class="sd">    :math:`C(x,y,t) = T(wu,Tu) * K(sigma_C,Tau_C) * L (x,y,t)`</span>

<span class="sd">    :math:`S(x,y,t) = K(sigma_S,Tau_S) * C(x,y,t)`</span>
<span class="sd">    p.275</span>

<span class="sd">    This Layer can use one of multiple implementations. :py:class:`HalfRecursiveOPLFilter`</span>
<span class="sd">    and :py:class:`SeperatableOPLFilter` both accept the same configuration attributes.</span>
<span class="sd">    Or :py:class:`FullConvolutionOPLFilter` which does not accept the</span>
<span class="sd">    parameters, but offers a single, non-separable convolution filter.</span>

<span class="sd">    Attributes</span>
<span class="sd">    ----------</span>

<span class="sd">    opl_filter : Layer</span>
<span class="sd">        The OPL filter that is used.</span>
<span class="sd">        Either :py:class:`HalfRecursiveOPLFilter`, :py:class:`SeperatableOPLFilter` or :py:class:`FullConvolutionOPLFilter`.</span>

<span class="sd">    See Also</span>
<span class="sd">    --------</span>

<span class="sd">    convis.retina.Retina</span>
<span class="sd">    HalfRecursiveOPLFilter</span>
<span class="sd">    SeperatableOPLFilter</span>
<span class="sd">    FullConvolutionOPLFilter</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">OPL</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dims</span> <span class="o">=</span> <span class="mi">5</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">opl_filter</span> <span class="o">=</span> <span class="n">HalfRecursiveOPLFilter</span><span class="p">()</span>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">filter_length</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">opl_filter</span><span class="o">.</span><span class="n">filter_length</span>
    <span class="k">def</span> <span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">opl_filter</span><span class="p">(</span><span class="n">x</span><span class="p">)</span></div>
 
<div class="viewcode-block" id="Bipolar"><a class="viewcode-back" href="../../../docs_retina.html#convis.filters.retina.Bipolar">[docs]</a><span class="k">class</span> <span class="nc">Bipolar</span><span class="p">(</span><span class="n">Layer</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Example Configuration::</span>

<span class="sd">        &#39;contrast-gain-control&#39;: {</span>
<span class="sd">            &#39;opl-amplification__Hz&#39;: 50, # for linear OPL: ampOPL = relative_ampOPL / fatherRetina-&gt;input_luminosity_range ;</span>
<span class="sd">                                                       # `ampInputCurrent` in virtual retina</span>
<span class="sd">            &#39;bipolar-inert-leaks__Hz&#39;: 50,             # `gLeak` in virtual retina</span>
<span class="sd">            &#39;adaptation-sigma__deg&#39;: 0.2,              # `sigmaSurround` in virtual retina</span>
<span class="sd">            &#39;adaptation-tau__sec&#39;: 0.005,              # `tauSurround` in virtual retina</span>
<span class="sd">            &#39;adaptation-feedback-amplification__Hz&#39;: 0 # `ampFeedback` in virtual retina</span>
<span class="sd">        },</span>

<span class="sd">    Attributes</span>
<span class="sd">    ----------</span>
<span class="sd">        opl-amplification__Hz : 50</span>
<span class="sd">            for linear OPL: ampOPL = relative_ampOPL / fatherRetina-&gt;input_luminosity_range ;</span>
<span class="sd">            `ampInputCurrent` in virtual retina</span>
<span class="sd">        bipolar-inert-leaks__Hz: 50</span>
<span class="sd">            `gLeak` in virtual retina</span>
<span class="sd">        adaptation-sigma__deg: 0.2</span>
<span class="sd">            `sigmaSurround` in virtual retina</span>
<span class="sd">        adaptation-tau__sec: 0.005</span>
<span class="sd">            `tauSurround` in virtual retina</span>
<span class="sd">        adaptation-feedback-amplification__Hz: 0</span>
<span class="sd">            `ampFeedback` in virtual retina</span>

<span class="sd">    See Also</span>
<span class="sd">    --------</span>

<span class="sd">    convis.retina.Retina</span>

<span class="sd">    </span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">Bipolar</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dims</span> <span class="o">=</span> <span class="mi">5</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lambda_amp</span> <span class="o">=</span> <span class="n">as_parameter</span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span>
                                        <span class="n">name</span><span class="o">=</span><span class="s2">&quot;lambda_amp&quot;</span><span class="p">,</span>
                                        <span class="n">retina_config_key</span><span class="o">=</span><span class="s1">&#39;adaptation-feedback-amplification__Hz&#39;</span><span class="p">,</span>
                                        <span class="n">doc</span><span class="o">=</span><span class="s1">&#39;Amplification of the gain control. When `lambda_amp=0`, there is no gain control.&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">g_leak</span> <span class="o">=</span> <span class="n">as_parameter</span><span class="p">(</span><span class="mf">50.0</span><span class="p">,</span><span class="n">init</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="nb">float</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">node</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;bipolar-inert-leaks__Hz&#39;</span><span class="p">,</span><span class="mi">50</span><span class="p">)),</span>
                                    <span class="n">name</span><span class="o">=</span><span class="s2">&quot;g_leak&quot;</span><span class="p">,</span>
                                    <span class="n">retina_config_key</span><span class="o">=</span><span class="s1">&#39;bipolar-inert-leaks__Hz&#39;</span><span class="p">,</span>
                                    <span class="n">doc</span><span class="o">=</span><span class="s1">&#39;leak current of the adaptation map (see also `tau`)&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">input_amp</span> <span class="o">=</span> <span class="n">as_parameter</span><span class="p">(</span><span class="mf">50.0</span><span class="p">,</span>
                                       <span class="n">init</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="nb">float</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">node</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;opl-amplification__Hz&#39;</span><span class="p">,</span><span class="mi">100</span><span class="p">)),</span>
                                       <span class="n">name</span><span class="o">=</span><span class="s2">&quot;input_amp&quot;</span><span class="p">,</span>
                                       <span class="n">retina_config_key</span><span class="o">=</span><span class="s1">&#39;opl-amplification__Hz&#39;</span><span class="p">,</span>
                                       <span class="n">doc</span><span class="o">=</span><span class="s1">&#39;linear input amplification&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">inputNernst_inhibition</span> <span class="o">=</span> <span class="mf">0.0</span>
                                    <span class="c1">#as_parameter(0.0,init=lambda x: float(x.node.config.get(&#39;inhibition_nernst&#39;,0.0)),</span>
                                    <span class="c1">#               name=&quot;inputNernst_inhibition&quot;,</span>
                                    <span class="c1">#               retina_config_key=&#39;inhibition_nernst&#39;)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tau</span> <span class="o">=</span> <span class="n">as_parameter</span><span class="p">(</span><span class="mf">5.0</span><span class="p">,</span><span class="n">init</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">resolution</span><span class="o">.</span><span class="n">seconds_to_steps</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">get_config_value</span><span class="p">(</span><span class="s1">&#39;adaptation-tau__sec&#39;</span><span class="p">,</span><span class="mf">0.005</span><span class="p">))),</span>
                           <span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;tau&#39;</span><span class="p">,</span> <span class="n">retina_config_key</span><span class="o">=</span><span class="s1">&#39;adaptation-tau__sec&#39;</span><span class="p">,</span>
                           <span class="n">doc</span><span class="o">=</span><span class="s1">&#39;time constant of the adaptation map (see also `g_leak`)&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">steps</span> <span class="o">=</span> <span class="n">Variable</span><span class="p">(</span><span class="mf">0.001</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">a_0</span> <span class="o">=</span> <span class="n">Variable</span><span class="p">(</span><span class="mf">1.0</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">a_1</span> <span class="o">=</span> <span class="o">-</span><span class="p">(</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">steps</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">tau</span><span class="p">)</span><span class="o">.</span><span class="n">exp</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">b_0</span> <span class="o">=</span>  <span class="mf">1.0</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">a_1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">conv2d</span> <span class="o">=</span> <span class="n">Conv2d</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,(</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">9</span><span class="p">,</span><span class="mi">9</span><span class="p">),</span><span class="n">autopad</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">conv2d</span><span class="o">.</span><span class="n">gaussian</span><span class="p">(</span><span class="mf">0.1</span><span class="p">)</span>
        <span class="c1">#self.conv2d.set_weight(1.0)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">register_state</span><span class="p">(</span><span class="s1">&#39;preceding_V_bip&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">register_state</span><span class="p">(</span><span class="s1">&#39;preceding_attenuationMap&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">register_state</span><span class="p">(</span><span class="s1">&#39;preceding_inhibition&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">init_states</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">input_shapes</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">preceding_V_bip</span> <span class="o">=</span> <span class="n">variables</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">input_shapes</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span><span class="n">input_shapes</span><span class="p">[</span><span class="mi">4</span><span class="p">]))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">preceding_attenuationMap</span> <span class="o">=</span> <span class="n">variables</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="n">input_shapes</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span><span class="n">input_shapes</span><span class="p">[</span><span class="mi">4</span><span class="p">]))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">preceding_inhibition</span> <span class="o">=</span> <span class="n">variables</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="n">input_shapes</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span><span class="n">input_shapes</span><span class="p">[</span><span class="mi">4</span><span class="p">]))</span>
    <span class="k">def</span> <span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
        <span class="n">y</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">y</span> <span class="o">=</span> <span class="n">variables</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
        <span class="c1"># initial slices</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">preceding_V_bip</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">init_states</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_use_cuda</span><span class="p">:</span>
            <span class="c1">#self.conv2d.cuda()</span>
            <span class="n">x</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">cuda</span><span class="p">()</span>
            <span class="n">y</span> <span class="o">=</span> <span class="n">y</span><span class="o">.</span><span class="n">cuda</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">a_1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">a_1</span><span class="o">.</span><span class="n">cuda</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">a_0</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">a_0</span><span class="o">.</span><span class="n">cuda</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">b_0</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">b_0</span><span class="o">.</span><span class="n">cuda</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">preceding_V_bip</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">preceding_V_bip</span><span class="o">.</span><span class="n">cuda</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">preceding_attenuationMap</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">preceding_attenuationMap</span><span class="o">.</span><span class="n">cuda</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">preceding_inhibition</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">preceding_inhibition</span><span class="o">.</span><span class="n">cuda</span><span class="p">()</span>
            <span class="n">g_leak</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">g_leak</span><span class="o">.</span><span class="n">cuda</span><span class="p">()</span>
            <span class="n">lambda_amp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lambda_amp</span><span class="o">.</span><span class="n">cuda</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">x</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span>
            <span class="n">y</span> <span class="o">=</span> <span class="n">y</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">a_1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">a_1</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">a_0</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">a_0</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">b_0</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">b_0</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">preceding_V_bip</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">preceding_V_bip</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">preceding_attenuationMap</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">preceding_attenuationMap</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">preceding_inhibition</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">preceding_inhibition</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span>
            <span class="n">g_leak</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">g_leak</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span>
            <span class="n">lambda_amp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lambda_amp</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span>
        <span class="n">preceding_V_bip</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">preceding_V_bip</span>
        <span class="n">preceding_attenuationMap</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">preceding_attenuationMap</span>
        <span class="n">preceding_inhibition</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">preceding_inhibition</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">input_image</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="n">dim</span><span class="o">=</span><span class="mi">2</span><span class="p">)):</span>
            <span class="n">total_conductance</span> <span class="o">=</span> <span class="n">g_leak</span> <span class="o">+</span> <span class="n">preceding_inhibition</span>
            <span class="n">attenuation_map</span> <span class="o">=</span> <span class="p">(</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">steps</span><span class="o">*</span><span class="n">total_conductance</span><span class="p">)</span><span class="o">.</span><span class="n">exp</span><span class="p">()</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">E_infinity</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">input_amp</span> <span class="o">*</span> <span class="n">input_image</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,:,:]</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">inputNernst_inhibition</span> <span class="o">*</span> <span class="n">preceding_inhibition</span><span class="p">)</span><span class="o">/</span><span class="n">total_conductance</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">input_amp</span><span class="o">.</span><span class="n">size</span><span class="p">(),</span>
                       <span class="n">input_image</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,:,:]</span><span class="o">.</span><span class="n">size</span><span class="p">(),</span>
                       <span class="bp">self</span><span class="o">.</span><span class="n">inputNernst_inhibition</span><span class="p">,</span>
                       <span class="n">preceding_inhibition</span><span class="o">.</span><span class="n">size</span><span class="p">(),</span>
                       <span class="n">total_conductance</span><span class="o">.</span><span class="n">size</span><span class="p">()))</span>
                <span class="k">raise</span>
            <span class="n">V_bip</span> <span class="o">=</span> <span class="p">((</span><span class="n">preceding_V_bip</span> <span class="o">-</span> <span class="n">E_infinity</span><span class="p">)</span> <span class="o">*</span> <span class="n">attenuation_map</span><span class="p">)</span> <span class="o">+</span> <span class="n">E_infinity</span> <span class="c1"># V_bip converges to E_infinity</span>
            
            <span class="n">inhibition</span> <span class="o">=</span> <span class="p">(</span><span class="n">lambda_amp</span><span class="o">*</span><span class="p">(</span><span class="n">preceding_V_bip</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span><span class="o">**</span><span class="mf">2.0</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">b_0</span> 
                                         <span class="o">-</span> <span class="n">preceding_inhibition</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">a_1</span><span class="p">)</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">a_0</span>
            <span class="c1"># smoothing with mean padding</span>
            <span class="n">inhibition</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">conv2d</span><span class="p">(</span><span class="n">inhibition</span><span class="p">[</span><span class="kc">None</span><span class="p">,:,:,:,:]</span> <span class="o">-</span> <span class="n">inhibition</span><span class="o">.</span><span class="n">mean</span><span class="p">())</span> <span class="o">+</span> <span class="n">inhibition</span><span class="o">.</span><span class="n">mean</span><span class="p">())[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,:,:]</span>
            <span class="c1"># next step and output</span>
            <span class="n">preceding_V_bip</span><span class="p">,</span> <span class="n">preceding_attenuationMap</span><span class="p">,</span> <span class="n">preceding_inhibition</span> <span class="o">=</span> <span class="n">V_bip</span><span class="p">,</span> <span class="n">attenuation_map</span><span class="p">,</span> <span class="n">inhibition</span>
            <span class="n">y</span><span class="p">[:,:,</span><span class="n">i</span><span class="p">,:,:]</span> <span class="o">=</span> <span class="n">V_bip</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">preceding_V_bip</span> <span class="o">=</span> <span class="n">preceding_V_bip</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">preceding_attenuationMap</span> <span class="o">=</span> <span class="n">preceding_attenuationMap</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">preceding_inhibition</span> <span class="o">=</span> <span class="n">preceding_inhibition</span>
        <span class="k">return</span> <span class="n">y</span></div>


<div class="viewcode-block" id="GanglionInput"><a class="viewcode-back" href="../../../docs_retina.html#convis.filters.retina.GanglionInput">[docs]</a><span class="k">class</span> <span class="nc">GanglionInput</span><span class="p">(</span><span class="n">Layer</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    The input current to the ganglion cells is filtered through a gain function.</span>

<span class="sd">    :math:`I_{Gang}(x,y,t) = G * N(eT * V_{Bip})`</span>


<span class="sd">    :math:`N(V) = \\frac{i^0_G}{1-\lambda(V-v^0_G)/i^0_G}` (if :math:`V &lt; v^0_G`)</span>

<span class="sd">    </span>
<span class="sd">    :math:`N(V) = i^0_G + \lambda(V-v^0_G)` (if :math:`V &gt; v^0_G`)</span>

<span class="sd">        Example configuration::</span>

<span class="sd">            {</span>
<span class="sd">                &#39;name&#39;: &#39;Parvocellular Off&#39;,</span>
<span class="sd">                &#39;enabled&#39;: True,</span>
<span class="sd">                &#39;sign&#39;: -1,</span>
<span class="sd">                &#39;transient-tau__sec&#39;:0.02,</span>
<span class="sd">                &#39;transient-relative-weight&#39;:0.7,</span>
<span class="sd">                &#39;bipolar-linear-threshold&#39;:0,</span>
<span class="sd">                &#39;value-at-linear-threshold__Hz&#39;:37,</span>
<span class="sd">                &#39;bipolar-amplification__Hz&#39;:100,</span>
<span class="sd">                &#39;sigma-pool__deg&#39;: 0.0,</span>
<span class="sd">                &#39;spiking-channel&#39;: {</span>
<span class="sd">                    ...</span>
<span class="sd">                }</span>
<span class="sd">            },</span>
<span class="sd">            {</span>
<span class="sd">                &#39;name&#39;: &#39;Magnocellular On&#39;,</span>
<span class="sd">                &#39;enabled&#39;: False,</span>
<span class="sd">                &#39;sign&#39;: 1,</span>
<span class="sd">                &#39;transient-tau__sec&#39;:0.03,</span>
<span class="sd">                &#39;transient-relative-weight&#39;:1.0,</span>
<span class="sd">                &#39;bipolar-linear-threshold&#39;:0,</span>
<span class="sd">                &#39;value-at-linear-threshold__Hz&#39;:80,</span>
<span class="sd">                &#39;bipolar-amplification__Hz&#39;:400,</span>
<span class="sd">                &#39;sigma-pool__deg&#39;: 0.1,</span>
<span class="sd">                &#39;spiking-channel&#39;: {</span>
<span class="sd">                    ...</span>
<span class="sd">                }</span>
<span class="sd">            },</span>


<span class="sd">    Examples</span>
<span class="sd">    ---------</span>

<span class="sd">    Setting the virtual Parameters::</span>

<span class="sd">        &gt;&gt;&gt; m = convis.filters.retina.GanglionInput()</span>
<span class="sd">        &gt;&gt;&gt; m.sigma_surround.set(0.1)</span>


<span class="sd">    Attributes</span>
<span class="sd">    ----------</span>
<span class="sd">    i_0 : Parameter</span>
<span class="sd">    v_0 : Parameter</span>
<span class="sd">    lambda_G : Parameter</span>
<span class="sd">    spatial_pooling : Conv3d</span>
<span class="sd">        convolution Op for spatial pooling. Can be set to </span>
<span class="sd">        a gaussian with :meth:`sigma_surround.set()`</span>
<span class="sd">    sigma_surround : VirtualParameter</span>
<span class="sd">        sets spatial_pooling to be a gaussian of a certain standard deviation</span>
<span class="sd">    transient</span>
<span class="sd">        convolution Op for high pass filtering</span>


<span class="sd">    See Also</span>
<span class="sd">    --------</span>

<span class="sd">    convis.retina.Retina</span>
<span class="sd">    GanglionSpiking</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">GanglionInput</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dims</span> <span class="o">=</span> <span class="mi">5</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sign</span> <span class="o">=</span> <span class="n">Parameter</span><span class="p">(</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">retina_config_key</span><span class="o">=</span><span class="s1">&#39;sign&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">transient</span> <span class="o">=</span> <span class="n">Conv3d</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="p">(</span><span class="mi">5</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">),</span> <span class="n">time_pad</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">autopad</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">transient_tau_center</span> <span class="o">=</span> <span class="n">variables</span><span class="o">.</span><span class="n">VirtualParameter</span><span class="p">(</span>
            <span class="nb">float</span><span class="p">,</span>
            <span class="n">value</span><span class="o">=</span><span class="mf">0.02</span><span class="p">,</span>
            <span class="n">retina_config_key</span><span class="o">=</span><span class="s1">&#39;transient-tau__sec&#39;</span><span class="p">,</span>
            <span class="n">doc</span><span class="o">=</span><span class="s1">&#39;The time constant of the transient filter component.&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">transient_relative_weight_center</span> <span class="o">=</span> <span class="n">variables</span><span class="o">.</span><span class="n">VirtualParameter</span><span class="p">(</span>
            <span class="nb">float</span><span class="p">,</span>
            <span class="n">value</span><span class="o">=</span><span class="mf">0.7</span><span class="p">,</span>
            <span class="n">retina_config_key</span><span class="o">=</span><span class="s1">&#39;transient-relative-weight&#39;</span><span class="p">,</span>
            <span class="n">doc</span><span class="o">=</span><span class="s1">&#39;&#39;&#39;The weight between the initial signal and the subtracted low-pass filtered signal.</span>
<span class="s1">0 is no change; 1 is equal weight to both signals resulting in a zero mean.&#39;&#39;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">set_callback_arguments</span><span class="p">(</span><span class="n">resolution</span><span class="o">=</span><span class="n">_get_default_resolution</span><span class="p">())</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">f_transient</span> <span class="o">=</span> <span class="n">variables</span><span class="o">.</span><span class="n">VirtualParameter</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">transient</span><span class="o">.</span><span class="n">highpass_exponential</span><span class="p">)</span><span class="o">.</span><span class="n">set_callback_arguments</span><span class="p">(</span>
                <span class="n">tau</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">transient_tau_center</span><span class="p">,</span>
                <span class="n">relative_weight</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">transient_relative_weight_center</span><span class="p">,</span>
                <span class="n">resolution</span><span class="o">=</span><span class="n">_get_default_resolution</span><span class="p">(),</span>
                <span class="n">adjust_padding</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">f_transient</span><span class="o">.</span><span class="n">update</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">i_0</span> <span class="o">=</span> <span class="n">Parameter</span><span class="p">(</span><span class="mf">37.0</span><span class="p">,</span> <span class="n">retina_config_key</span><span class="o">=</span><span class="s1">&#39;value-at-linear-threshold__Hz&#39;</span><span class="p">,</span>
            <span class="n">doc</span><span class="o">=</span><span class="s1">&#39;Parameter of the static non-linearity: output value at the input level `bipolar-linear-threshold`&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">v_0</span> <span class="o">=</span> <span class="n">Parameter</span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">retina_config_key</span><span class="o">=</span><span class="s1">&#39;bipolar-linear-threshold&#39;</span><span class="p">,</span>
            <span class="n">doc</span><span class="o">=</span><span class="s1">&#39;Parameter of the static non-linearity: inputs above this value will be treated linearly.&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lambda_G</span> <span class="o">=</span> <span class="n">Parameter</span><span class="p">(</span><span class="mf">100.0</span><span class="p">,</span> <span class="n">retina_config_key</span><span class="o">=</span><span class="s1">&#39;bipolar-amplification__Hz&#39;</span><span class="p">,</span>
            <span class="n">doc</span><span class="o">=</span><span class="s1">&#39;Parameter of the static non-linearity: linear amplification of the input&#39;</span><span class="p">)</span>
        <span class="c1">#self.high_pass = nn.Conv1d()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">input_state</span> <span class="o">=</span> <span class="n">State</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">)))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">spatial_pooling</span> <span class="o">=</span> <span class="n">Conv3d</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,(</span><span class="mi">1</span><span class="p">,</span><span class="mi">9</span><span class="p">,</span><span class="mi">9</span><span class="p">),</span> <span class="n">time_pad</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">autopad</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sigma_surround</span> <span class="o">=</span> <span class="n">variables</span><span class="o">.</span><span class="n">VirtualParameter</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">spatial_pooling</span><span class="o">.</span><span class="n">gaussian</span><span class="p">,</span>
            <span class="n">value</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span>
            <span class="n">retina_config_key</span><span class="o">=</span><span class="s1">&#39;sigma-pool__deg&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">set_callback_arguments</span><span class="p">(</span>
                <span class="n">adjust_padding</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="n">resolution</span><span class="o">=</span><span class="n">_get_default_resolution</span><span class="p">())</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sigma_surround</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="mf">0.0</span><span class="p">)</span>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">filter_length</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">transient</span><span class="o">.</span><span class="n">weight</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="n">TIME_DIMENSION</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span> 
    <span class="k">def</span> <span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">input_state</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="n">TIME_DIMENSION</span><span class="p">]</span> <span class="o">==</span> <span class="mi">2</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">filter_length</span> <span class="ow">and</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">input_state</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">==</span> <span class="n">x</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="ow">and</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">input_state</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">==</span> <span class="n">x</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">4</span><span class="p">]):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">input_state</span> <span class="o">=</span> <span class="n">State</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">x</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">x</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="mi">2</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">filter_length</span><span class="p">,</span><span class="n">x</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span><span class="n">x</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">4</span><span class="p">])))</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_use_cuda</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">input_state</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">input_state</span><span class="o">.</span><span class="n">cuda</span><span class="p">()</span>
        <span class="n">x_pad</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">input_state</span><span class="p">,</span> <span class="n">x</span><span class="p">],</span> <span class="n">dim</span><span class="o">=</span><span class="n">TIME_DIMENSION</span><span class="p">)</span>
        <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sign</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">transient</span><span class="p">(</span><span class="n">x_pad</span><span class="p">)[:,:,</span><span class="bp">self</span><span class="o">.</span><span class="n">filter_length</span><span class="p">:,:,:]</span>
        <span class="n">n</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">i_0</span><span class="o">/</span><span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">lambda_G</span><span class="o">*</span><span class="p">(</span><span class="n">x</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">v_0</span><span class="p">)</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">i_0</span><span class="p">))</span>
        <span class="n">n_greater</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">i_0</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">lambda_G</span><span class="o">*</span><span class="p">(</span><span class="n">x</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">v_0</span><span class="p">))</span>
        <span class="n">cond</span> <span class="o">=</span> <span class="n">x</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">v_0</span>
        <span class="n">n</span><span class="o">.</span><span class="n">masked_scatter_</span><span class="p">(</span><span class="n">cond</span><span class="p">,</span><span class="n">n_greater</span><span class="o">.</span><span class="n">masked_select</span><span class="p">(</span><span class="n">cond</span><span class="p">))</span> <span class="c1"># pytorch docs should have an example about this</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">input_state</span> <span class="o">=</span> <span class="n">x_pad</span><span class="p">[:,:,</span><span class="o">-</span><span class="mi">2</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">filter_length</span><span class="p">:,:,:]</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">spatial_pooling</span><span class="p">(</span><span class="n">n</span><span class="p">)</span></div>

<div class="viewcode-block" id="GanglionSpiking"><a class="viewcode-back" href="../../../docs_retina.html#convis.filters.retina.GanglionSpiking">[docs]</a><span class="k">class</span> <span class="nc">GanglionSpiking</span><span class="p">(</span><span class="n">Layer</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    The ganglion cells recieve the gain controlled input and produce spikes. </span>

<span class="sd">    When the cell is not refractory, :math:`V` moves as:</span>

<span class="sd">    $$ \\\\dfrac{ dV_n }{dt} = I_{Gang}(x_n,y_n,t) - g^L V_n(t) + \eta_v(t)$$</span>

<span class="sd">    Otherwise it is set to 0.</span>


<span class="sd">    Attributes</span>
<span class="sd">    ----------</span>

<span class="sd">    refr_mu : Parameter</span>
<span class="sd">        The mean of the distribution of random refractory times (in seconds).</span>
<span class="sd">    refr_sigma : Parameter</span>
<span class="sd">        The standard deviation of the refractory time that is randomly drawn around `refr_mu`</span>
<span class="sd">    noise_sigma : Parameter</span>
<span class="sd">        Amount of noise added to the membrane potential.</span>
<span class="sd">    g_L : Parameter</span>
<span class="sd">        Leak current (in Hz or dimensionless firing rate).</span>


<span class="sd">    See Also</span>
<span class="sd">    --------</span>

<span class="sd">    convis.retina.Retina</span>
<span class="sd">    GanglionInput</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">GanglionSpiking</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dims</span> <span class="o">=</span> <span class="mi">5</span>
        <span class="c1"># parameters</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">refr_mu</span> <span class="o">=</span> <span class="n">Parameter</span><span class="p">(</span><span class="mf">0.003</span><span class="p">,</span>
                            <span class="n">retina_config_key</span><span class="o">=</span><span class="s1">&#39;refr-mean__sec&#39;</span><span class="p">,</span>
                            <span class="n">doc</span><span class="o">=</span><span class="s1">&#39;The mean of the distribution of random refractory times (in seconds).&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">refr_sigma</span> <span class="o">=</span> <span class="n">Parameter</span><span class="p">(</span><span class="mf">0.001</span><span class="p">,</span>
                            <span class="n">retina_config_key</span><span class="o">=</span><span class="s1">&#39;refr-stdev__sec&#39;</span><span class="p">,</span>
                            <span class="n">doc</span><span class="o">=</span><span class="s1">&#39;The standard deviation of the refractory time that is randomly drawn around `refr_mu`&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">noise_sigma</span> <span class="o">=</span> <span class="n">Parameter</span><span class="p">(</span><span class="mf">0.1</span><span class="p">,</span>
                            <span class="n">retina_config_key</span><span class="o">=</span><span class="s1">&#39;sigma-V&#39;</span><span class="p">,</span>
                            <span class="n">doc</span><span class="o">=</span><span class="s1">&#39;Amount of noise added to the membrane potential.&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">g_L</span> <span class="o">=</span> <span class="n">Parameter</span><span class="p">(</span><span class="mf">50.0</span><span class="p">,</span>
                            <span class="n">retina_config_key</span><span class="o">=</span><span class="s1">&#39;g-leak__Hz&#39;</span><span class="p">,</span>
                            <span class="n">doc</span><span class="o">=</span><span class="s1">&#39;Leak current (in Hz or dimensionless firing rate).&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tau</span> <span class="o">=</span> <span class="n">Parameter</span><span class="p">(</span><span class="mf">0.001</span><span class="p">,</span>
                            <span class="n">retina_config_key</span><span class="o">=</span><span class="s1">&#39;--should be inherited&#39;</span><span class="p">,</span>
                            <span class="n">doc</span> <span class="o">=</span> <span class="s1">&#39;Length of timesteps (ie. the steps_to_seconds(1.0) of the model.&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">register_state</span><span class="p">(</span><span class="s1">&#39;V&#39;</span><span class="p">,</span><span class="kc">None</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">register_state</span><span class="p">(</span><span class="s1">&#39;zeros&#39;</span><span class="p">,</span><span class="kc">None</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">register_state</span><span class="p">(</span><span class="s1">&#39;refr&#39;</span><span class="p">,</span><span class="kc">None</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">register_state</span><span class="p">(</span><span class="s1">&#39;noise_prev&#39;</span><span class="p">,</span><span class="kc">None</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">init_states</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">input_shape</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">zeros</span> <span class="o">=</span> <span class="n">variables</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">input_shape</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span><span class="n">input_shape</span><span class="p">[</span><span class="mi">4</span><span class="p">]))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">V</span> <span class="o">=</span> <span class="mf">0.5</span><span class="o">+</span><span class="mf">0.2</span><span class="o">*</span><span class="n">variables</span><span class="o">.</span><span class="n">rand</span><span class="p">((</span><span class="n">input_shape</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span><span class="n">input_shape</span><span class="p">[</span><span class="mi">4</span><span class="p">]))</span> <span class="c1"># membrane potential</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_use_cuda</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">refr</span> <span class="o">=</span> <span class="mf">1000.0</span><span class="o">*</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">refr_mu</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">refr_sigma</span> <span class="o">*</span>
                                <span class="n">variables</span><span class="o">.</span><span class="n">randn</span><span class="p">((</span><span class="n">input_shape</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span><span class="n">input_shape</span><span class="p">[</span><span class="mi">4</span><span class="p">]))</span><span class="o">.</span><span class="n">cuda</span><span class="p">())</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">refr</span> <span class="o">=</span> <span class="mf">1000.0</span><span class="o">*</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">refr_mu</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">refr_sigma</span> <span class="o">*</span>
                                <span class="n">variables</span><span class="o">.</span><span class="n">randn</span><span class="p">((</span><span class="n">input_shape</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span><span class="n">input_shape</span><span class="p">[</span><span class="mi">4</span><span class="p">]))</span><span class="o">.</span><span class="n">cpu</span><span class="p">())</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">noise_prev</span> <span class="o">=</span> <span class="n">variables</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">input_shape</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span><span class="n">input_shape</span><span class="p">[</span><span class="mi">4</span><span class="p">]))</span>
    <span class="k">def</span> <span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">I_gang</span><span class="p">):</span>
        <span class="n">g_infini</span> <span class="o">=</span> <span class="mf">50.0</span> <span class="c1"># apparently?</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="s1">&#39;V&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">V</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">init_states</span><span class="p">(</span><span class="n">I_gang</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_use_cuda</span><span class="p">:</span>
            <span class="c1">#y = torch.autograd.Variable(torch.zeros(I_gang.data.shape)).cuda()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">V</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">V</span><span class="o">.</span><span class="n">cuda</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">refr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">refr</span><span class="o">.</span><span class="n">cuda</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">zeros</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">zeros</span><span class="o">.</span><span class="n">cuda</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">noise_prev</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">noise_prev</span><span class="o">.</span><span class="n">cuda</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1">#y = torch.autograd.Variable(torch.zeros(I_gang.data.shape)).cpu()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">V</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">V</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">refr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">refr</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">zeros</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">zeros</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">noise_prev</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">noise_prev</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span>
        <span class="n">all_spikes</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">t</span><span class="p">,</span> <span class="n">I</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">I_gang</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="mi">0</span><span class="p">)):</span>
            <span class="c1">#print I.data.shape, self.V.data.shape,torch.randn(I.data.shape).shape</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_use_cuda</span><span class="p">:</span>
                <span class="n">noise</span> <span class="o">=</span> <span class="n">variables</span><span class="o">.</span><span class="n">randn</span><span class="p">(</span><span class="n">I</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span><span class="o">.</span><span class="n">cuda</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">noise</span> <span class="o">=</span> <span class="n">variables</span><span class="o">.</span><span class="n">randn</span><span class="p">(</span><span class="n">I</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span>
            <span class="n">V</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">V</span> <span class="o">+</span> <span class="p">(</span><span class="n">I</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">g_L</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">V</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">noise_sigma</span><span class="o">*</span><span class="n">noise</span><span class="o">*</span><span class="n">torch</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">g_L</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">tau</span><span class="p">))</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">tau</span>
            <span class="c1"># canonical form: </span>
            <span class="c1">#</span>
            <span class="c1"># V = V + (E_L - V + R*I)*dt/tau </span>
            <span class="c1">#      + self.noise_sigma*noise*torch.sqrt(2.0*dt/tau)</span>
            <span class="c1"># with dt = self.tau</span>
            <span class="c1">#      tau = 1/self.g_L</span>
            <span class="c1">#      R = tau</span>
            <span class="c1">#      E_L = 0</span>
            <span class="c1">#</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_use_cuda</span><span class="p">:</span>
                <span class="n">refr_noise</span> <span class="o">=</span> <span class="mf">1000.0</span><span class="o">*</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">refr_mu</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">refr_sigma</span> <span class="o">*</span>
                                    <span class="n">variables</span><span class="o">.</span><span class="n">randn</span><span class="p">(</span><span class="n">I</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span><span class="o">.</span><span class="n">cuda</span><span class="p">())</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">refr_noise</span> <span class="o">=</span> <span class="mf">1000.0</span><span class="o">*</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">refr_mu</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">refr_sigma</span> <span class="o">*</span>
                                    <span class="n">variables</span><span class="o">.</span><span class="n">randn</span><span class="p">(</span><span class="n">I</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span><span class="o">.</span><span class="n">cpu</span><span class="p">())</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">refr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">refr</span> <span class="o">-</span> <span class="mf">1.0</span>
            <span class="n">V</span><span class="o">.</span><span class="n">masked_scatter_</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">refr</span> <span class="o">&gt;=</span> <span class="mf">0.5</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">zeros</span><span class="p">)</span>
            <span class="n">spikes</span> <span class="o">=</span> <span class="n">V</span> <span class="o">&gt;</span> <span class="mf">1.0</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">refr</span><span class="o">.</span><span class="n">masked_scatter_</span><span class="p">(</span><span class="n">spikes</span><span class="p">,</span> <span class="n">refr_noise</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">refr</span><span class="o">.</span><span class="n">masked_scatter_</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">refr</span> <span class="o">&lt;</span> <span class="mf">0.0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">zeros</span><span class="p">)</span>
            <span class="n">V</span><span class="o">.</span><span class="n">masked_scatter_</span><span class="p">(</span><span class="n">spikes</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">zeros</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">V</span> <span class="o">=</span> <span class="n">V</span>
            <span class="n">all_spikes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">spikes</span><span class="p">[</span><span class="kc">None</span><span class="p">,:,:])</span>
        <span class="k">return</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">(</span><span class="n">all_spikes</span><span class="p">,</span><span class="n">dim</span><span class="o">=</span><span class="mi">0</span><span class="p">)[</span><span class="kc">None</span><span class="p">,</span><span class="kc">None</span><span class="p">,:,:,:]</span></div>
</pre></div>

           </div>
           <div class="articleComments">
            
           </div>
          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2016, Jacob Huth.

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/snide/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  

    <script type="text/javascript">
        var DOCUMENTATION_OPTIONS = {
            URL_ROOT:'../../../',
            VERSION:'0.6.4',
            COLLAPSE_INDEX:false,
            FILE_SUFFIX:'.html',
            HAS_SOURCE:  true,
            SOURCELINK_SUFFIX: '.txt'
        };
    </script>
      <script type="text/javascript" src="../../../_static/jquery.js"></script>
      <script type="text/javascript" src="../../../_static/underscore.js"></script>
      <script type="text/javascript" src="../../../_static/doctools.js"></script>
      <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>

  

  
  
    <script type="text/javascript" src="../../../_static/js/theme.js"></script>
  

  
  
  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.StickyNav.enable();
      });
  </script>
   

</body>
</html>